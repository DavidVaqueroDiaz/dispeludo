<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DiseÃ±o Peludo</title>
<style>
  *{box-sizing:border-box}
  body{font-family:sans-serif;margin:0;padding:20px;background:#fff8f0;text-align:center}
  .logo{max-width:180px;margin:10px auto}

  .selector{display:flex;justify-content:center;gap:10px;margin:20px 0}
  .selector img{width:80px;height:80px;object-fit:contain;border:2px solid #ccc;border-radius:8px;cursor:pointer;transition:.2s}
  .selector img.activo{border-color:#25d366}

  #preview{position:relative;width:350px;height:350px;margin:0 auto;overflow:hidden}
  #preview img{width:100%;height:100%;object-fit:contain}
  #grabado{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;opacity:.75;pointer-events:none;display:none}

  #info{width:350px;margin:8px auto 16px auto;background:#444;color:#fff;padding:6px;font-size:14px;border-radius:4px}

  input,button{font-size:16px;padding:10px;border-radius:8px;border:1px solid #ccc;margin:8px auto;display:block;width:90%;max-width:350px}
  .btn{background:#25d366;color:#fff;border:none;font-weight:bold;cursor:pointer}
  .btn:hover{background:#1ebe5d}
  small{display:block;margin-top:10px;color:#555}
</style>
</head>
<body>

<img class="logo" src="Logo%20color.svg" alt="Logo DiseÃ±o Peludo">

<h2>Sube la foto de tu mascota y elige tamaÃ±o</h2>

<div class="selector" id="selector">
  <img src="S.png"  data-size="S"  data-diam="11" data-price="12" alt="Comedero S">
  <img src="M.png"  data-size="M"  data-diam="16" data-price="14" alt="Comedero M">
  <img src="L.png"  data-size="L"  data-diam="19" data-price="15" alt="Comedero L">
  <img src="XL.png" data-size="XL" data-diam="22" data-price="17" alt="Comedero XL">
</div>

<div id="preview">
  <img id="cuencoBase" src="S.png" alt="Vista previa">
  <img id="grabado"   src=""    alt="">
</div>

<div id="info"></div>

<input type="file" id="foto" accept="image/*">

<button class="btn" id="btnIA">ðŸ§  Enviar imagen a IA</button>

<a class="btn" href="https://wa.me/34679285964?text=Hola%20quiero%20un%20comedero%20personalizado" target="_blank">
  ðŸ“± EscrÃ­beme por WhatsApp
</a>

<h3>Datos para tramitar el pedido</h3>
<input id="nombre"  placeholder="Nombre completo">
<input id="telefono" placeholder="TelÃ©fono (WhatsApp)">
<button class="btn" id="tramitar">ðŸ“¦ Tramitar pedido</button>

<small>RecibirÃ¡s el diseÃ±o final tras confirmar el pedido.</small>

<script>
/* ---------- variables globales ---------- */
let selectedSize = 'S';
let fotoCargada  = false;

const selector   = document.getElementById('selector');
const cuencoBase = document.getElementById('cuencoBase');
const grabado    = document.getElementById('grabado');
const infoBox    = document.getElementById('info');
const fileInput  = document.getElementById('foto');

/* ---------- selector de tamaÃ±o ---------- */
selector.onclick = (e)=>{
  if(e.target.tagName !== 'IMG') return;

  [...selector.children].forEach(img=>img.classList.remove('activo'));
  e.target.classList.add('activo');

  selectedSize   = e.target.dataset.size;
  cuencoBase.src = e.target.src;

  if(!fotoCargada) cuencoBase.style.display='block';

  infoBox.textContent = `Ã˜${e.target.dataset.diam} cm Â· ${e.target.dataset.price} â‚¬`;
};

/* valor inicial */
selector.firstElementChild.classList.add('activo');
infoBox.textContent = 'Ã˜11 cm Â· 12 â‚¬';

/* ---------- subida de imagen ---------- */
fileInput.onchange = (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ev=>{
    grabado.src           = ev.target.result;
    grabado.style.display = 'block';
    cuencoBase.style.display = 'none';
    fotoCargada = true;
  };
  reader.readAsDataURL(file);
};

/* ---------- botÃ³n IA (abre tu GPT en otra pestaÃ±a) ---------- */
document.getElementById('btnIA').onclick = ()=>{
  const file = fileInput.files[0];
  if(!file) return alert('Sube una imagen primero');
  window.open('https://chatgpt.com/g/g-680d11d6dafc819199cd6a3cd71a87cb-ilustra-tu-mascota','_blank');
};

/* ---------- botÃ³n Tramitar pedido ---------- */
document.getElementById('tramitar').onclick = async ()=>{
  const nombre = document.getElementById('nombre').value.trim();
  const tel    = document.getElementById('telefono').value.trim();
  if(!nombre || !tel){
    alert('Rellena nombre y telÃ©fono');
    return;
  }

  /* leer la imagen en base64 (sin encabezado data:) */
  let imageData = null;
  if(fileInput.files.length){
    const file = fileInput.files[0];
    imageData = await new Promise(res=>{
      const r = new FileReader();
      r.onload = () => res(r.result.split(',')[1]);
      r.readAsDataURL(file);
    });
  }

  const body = {
    nombre,
    telefono: tel,
    size: selectedSize,
    imageData                // puede ser null si no hay foto
  };

  try{
    const res = await fetch('/.netlify/functions/tramitar',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(res.ok){
      alert('Â¡Pedido recibido!');
    }else{
      const errText = await res.text();
      console.error(errText);
      alert('Error al enviar pedido');
    }
  }catch(err){
    console.error(err);
    alert('Error de conexiÃ³n');
  }
};
</script>

</body>
</html>
